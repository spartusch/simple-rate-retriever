#!/bin/bash

project_name='simple-rate-retriever'
deploy_dir='/home/pi/deploy/simple-rate-retriever'
repo_dir='/home/pi/repos/simple-rate-retriever.git'
server_port=18091

while read oldrev newrev ref
do
    if [[ $ref =~ .*/master$ ]];
    then
        echo "=> Deploying master branch..."
		git --work-tree=$deploy_dir --git-dir=$repo_dir checkout -f

		echo
		pid=$(ps aux | egrep '[j]ava .+/'$project_name'.*\.jar' | awk '{print $2}')
		if [ -z $pid ];
		then
			echo "=> No running instance detected";
		else
			echo "=> Killing running instance (pid: $pid)...";
			kill $pid
		fi

		echo
		echo "=> Building deployed master branch..."
		$deploy_dir/gradlew -p $deploy_dir bootJar

		echo
		echo "=> Starting new instance..."
		nohup java -Dserver.port=$server_port -jar $deploy_dir/build/libs/$project_name*.jar &>$deploy_dir/output &

		echo "=> Done"
    else
        echo "Ref $ref received successfully. Doing nothing: only the master branch will be deployed on this server."
    fi
done
